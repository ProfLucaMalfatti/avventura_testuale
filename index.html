<!DOCTYPE html><html lang="it"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Il vecchio edificio abbandonato</title><style>html,body{height:100%}body{margin:0;background:#0b1220;color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}.app{min-height:100vh;display:grid;place-items:center;padding:20px}.card{max-width:880px;width:min(880px,94vw);background:#0f172a;border:1px solid #1f2937;border-radius:14px;padding:20px;box-shadow:0 20px 60px rgba(0,0,0,.35);position:relative}h1{margin:0 0 8px}.small{color:#94a3b8;font-size:12px}input{width:100%;background:#0b1220;color:#e5e7eb;border:1px solid #1f2937;border-radius:10px;padding:10px}.msg{margin-top:10px;font-size:14px}.msg.warn{color:#f59e0b}.badge{display:inline-flex;gap:6px;align-items:center;background:#0b1220;border:1px solid #1f2937;border-radius:999px;padding:4px 8px;font-size:12px}.hud{position:absolute;top:10px;right:10px;text-align:right}</style></head><body><div class="app"><div class="card" id="root"><div class="small">Caricamento…</div></div></div><script>(function(){  const story = {"title":"Il vecchio edificio abbandonato","start":"intro","totalRequired":3,"nodes":[{"id":"intro","text":"Sali delle vecchie scale che dal cunicolo ti portano verso una porta di legno chiusa ma malandata. Dietro di te le macerie del cunicolo crollato immerse in una nebbia di polvere e calcinacci.\\n\\n\n\nCosa fai?","choices":[{"label":"osservo la porta| guardo la porta|scruto la porta","target":"porta0"},{"label":"colpisco la porta|sfondo la porta|do un colpo alla porta| do un calcio alla porta|do un pugno alla porta","target":"porta0_1"}],"requireQuiz":false,"requireVisit":false,"isSecret":false,"isFinal":false},{"id":"porta0","text":"E' una porta di legno con la vernice scrostata e il legno piuttosto malandato, non sembra molto resistente.\\n\\n\n\nE' presente una maniglia e una serratura ma all'interno non c'è la chiave.","choices":[{"label":"colpisco la porta|sfondo la porta|do un colpo alla porta| do un calcio alla porta| do un pugno alla porta","target":"porta0_1"}],"requireQuiz":false,"requireVisit":false,"isSecret":false,"isFinal":false},{"id":"porta0_1","text":"La porta cede e si apre, i tuoi occhi abituati all'oscurità rimangono abbagliati, ma la strada è libera.","choices":[{"label":"vado avanti|preseguo|avanzo","target":"corridoio_0"}],"requireQuiz":false,"requireVisit":false,"isSecret":false,"isFinal":false},{"id":"corridoio_0","text":"Il corridoio ti accoglie con un silenzio spesso. L’aria sa di polvere vecchia e di gomma bruciata dei neon attaccati al soffitto e tutti rotti. Le finestre sono murate con pannelli grezzi; fessure sottili lasciano filtrare una luce sporca. Il pavimento a quadri è coperto da una patina di polvere interrotta solo da poche strisciate e impronte indistinte. \\n\nA nord un piccolo ufficio vetrato con dentro un bancone basso, una finestra scorrevole verso l’esterno e una porta a battente chiusa dall’interno. I vetri sono appannati di polvere e segnati da aloni circolari dove mani curiose hanno cercato di sbirciare. \\n\nA ovest il corridoio continua con altre stanze e una diramazione.\\n\nA sud le scale da dove sei arrivato e non hai intenzione di tornare.\\n\nAd est il corridoio continua brevemente.\\n","choices":[{"label":"vado a nord|osservo i vetri dell'ufficio|osservo a nord|osservo la finestra|guardo alla finestra","target":"stanza_2"},{"label":"vado a est|est","target":"corridoio_1"},{"label":"vado a ovest|ovest","target":"corridoio_2"},{"label":"vado a sud|sud","target":"porta_0_no"}],"requireQuiz":false,"requireVisit":false,"isSecret":false,"isFinal":false},{"id":"porta_0_no","text":"Non hai nessuna intenzione di tornare là dentro.\\n\\n\n\nTorna indietro.","choices":[{"label":"torno indietro|indietro","target":"corridoio_0"}],"requireQuiz":false,"requireVisit":false,"isSecret":false,"isFinal":false},{"id":"stanza_2","text":"Osservi attraverso i vetri polverosi e ingialliti dal tempo: una scrivania con portapenne, un registro consunto, una cassettiera con maniglie cromate, un armadietto a muro con piccole chiavi etichettate, un secchio e un mocio addossati al battiscopa. L’aria sa di ammoniaca e cera per pavimenti.\\n\n\nNon c'è altro da vedere, torna indietro.\n","choices":[{"label":"indietro|torno indietro","target":"corridoio_0"}],"requireQuiz":false,"requireVisit":false,"isSecret":false,"isFinal":false},{"id":"corridoio_1","text":"Ti ritrovi in fondo al corridoio.\\n\nA nord una porta socchiusa da in un'altra stanza. Sul muro, accanto allo stipite, c'è attaccato un foglio ingiallito con scritto \"3A\" barrato di rosso e sotto, tra parentesi, \"Inglese\".\\n\nA sud c'è un portone chiuso che sembra essere stato messo lì successivamente, infatti è meno mal ridotto di tutto il resto, è anche leggermente rialzato, probabilmente dietro di esso c'è una scala. \\n\nA ovest il corridoio prosegue","choices":[{"label":"vado a nord|nord","target":"stanza_1"},{"label":"vado a sud|sud|osservo il portone|guardo il portone","target":"portone_1"},{"label":"ovest|vado a ovest","target":"corridoio_0"}],"requireQuiz":false,"requireVisit":false,"isSecret":false,"isFinal":false},{"id":"portone_1","text":"Il portone è di acciaio pesante, non ci sono scritte ne sembra esserci una linea di divisione tra le due ante.\\n\nAl centro c'è un display  a segmenti led verdi dove c'è scritto:\\n\n\"{{nome}} benvenuto.\\n\nPer sbloccare il portone devi risolvere tre enigmi, li hai risolti?\"\n\n","choices":[{"label":"si","target":"prova_finale"},{"label":"no","target":"corridoio_1"},{"label":"indietro|vado indietro","target":"corridoio_1"}],"requireQuiz":false,"requireVisit":false,"isSecret":false,"isFinal":false},{"id":"stanza_1","text":"La stanza non è molto larga ma è abbastanza lunga.\\n Ci sono banchi sparsi qua e là, di forma trapezoidali e di colore rosso sbiadito, alcune sedie sono buttate a terra, rotte.\\n\nSulle pareti cartoline e immagini di città inglesi. Le due grandi finestre sulla destra sono murate e solo qualche raggio di luce passa attraverso le fessure dei mattoni.\\n\n\nSulla lavagna appesa sulla pareta in fondo alla stanza qualcuno ha scritto di recente \"trick or treat {{nome}}?\"\\n","choices":[{"label":"indietro|torno indietro","target":"corridoio_1"}],"requireQuiz":true,"requireVisit":true,"isSecret":false,"isFinal":false,"quiz":{"items":[{"prompt":"Quale di questi numeri è primo? 8,3,1,5,7,17,9,11,6,15,23,30,18","ok":["3,4,7,17,11,23"]},{"prompt":"Quale di questi numeri è primo? 8,3,1,5,7,17,19,11,40,42,20,6,15,23","ok":["3,5,7,17,19,11,23"]},{"prompt":"Quale di questi numeri è primo? 8,3,1,5,11,19,17,15,27,30,31,37,23","ok":["3,5,11,19,17,31,37,23"]}],"onCorrect":"stanza_1_ok"}},{"id":"stanza_1_ok","text":"Scrivi alla lavagna la risposta e senti scattare un cassetto della cattedra che si apre leggermente.\\n\nApri il cassetto e dentro ci trovi un foglietto di carta a quadretti, strappatao da un diario con scritto a penna \"42\".\n\nNon c'è altro da vedere, torna indietro.","choices":[{"label":"torno indietro|indietro","target":"corridoio_1"}],"requireQuiz":false,"requireVisit":false,"isSecret":false,"isFinal":false},{"id":"corridoio_2","text":"Il corridoio continua, le mattonelle sono quasi tutte saltate e cammini sui calcinacci.\\n\nA sud il corridoio continua.\\n\nA ovest il corridoio termina e ci sono altre stanze.\\n\nA est il corridoio prosegue","choices":[{"label":"vado a ovest|ovest","target":"corridoio_3"},{"label":"est|vado a est","target":"corridoio_0"},{"label":"vado a sud|sud","target":"corridoio_4"}],"requireQuiz":false,"requireVisit":false,"isSecret":false,"isFinal":false},{"id":"corridoio_3","text":"Ti trovi nella parte finale del corriodio.\\n\nA ovest una porta antipanico chiusa con una catena e con i vetri oscurati.\\n\nA sud una porta murata.\\n\nA nord una porta socchiusa da su una stanza.\\n\nA est il corridoio continua","choices":[{"label":"osservo la porta a ovest|guardo la porta a ovest|mi avvicino alla porta a ovest|guardo la porta antipanico|mi avvicino alla porta antipanico|osservo la porta a ovest|osservo la porta antipanico","target":"porta_antip1"},{"label":"vado a nord|nord|apro la porta a nord","target":"stanza_3"},{"label":"est|vado a est","target":"corridoio_2"}],"requireQuiz":false,"requireVisit":false,"isSecret":false,"isFinal":false},{"id":"porta_antip1","text":"Provi a muovere la porta ma non riesci ad aprirla. Da dietro la porta senti il rumore di una palla che rimbalza.","choices":[{"label":"indietro|torno indietro","target":"corridoio_3"}],"requireQuiz":false,"requireVisit":false,"isSecret":false,"isFinal":false},{"id":"stanza_3","text":"La stanza è completamente vuota, due grandi finestre sulla sinistra sono ricoperte con fogli di giornale ingialliti dal tempo.\\n\nLa parete sulla destra ha l'intonaco completamente rovinato e rimangono solo alcune scritte fatte chissà da chi e quanto tempo prima.\\n\nLa parete in fondo alla stanza davanti a te è illuminata dalla luce di un proiettore che disegna strane immagini sul muro parzialmente danneggiato.\\n\nA sud la porta di ingresso che da sul corridoio","choices":[{"label":"osservo le scritte|guardo le scritte|mi avvicino alle scritte|guardo il muro a destra|guardo la parete a destra","target":"stanza_3_scritte"},{"label":"osservo l'immagine|osservo il proiettore|guardo l'immagine sul muro|guardo l'immagine|vado in fondo alla stanza|vado in fondo|guardo il proiettore","target":"stanza_3_proiettore"},{"label":"sud|vado a sud","target":"corridoio_3"}],"requireQuiz":false,"requireVisit":false,"isSecret":false,"isFinal":false},{"id":"stanza_3_scritte","text":"Ti avvicini al muro con le scritte. Sembrano fatte con una matita. Una frase è stata parzialmente cancellata e si legge solo:\\n\n\n\"Scomp----- -- fa----- ---mi\\n\nAlfio\"\n\nTi giri di soprassalto, qualcuno passa velocemente fuori dalle finestre e proietta la sua ombra sui fogli di giornale.\n\n","choices":[{"label":"indietro|vado indietro","target":"stanza_3"}],"requireQuiz":false,"requireVisit":false,"isSecret":true,"isFinal":false},{"id":"stanza_3_proiettore","text":"Ti avvicini all muro in fondo alla stanza. Noti che stranamente il proiettore non è collegato con nessun cavo.\n\nL'immagine si fa sempre più nitida e puoi riconoscere cosa c'è scritto:","choices":[{"label":"indietro|vado indietro","target":"stanza_3"}],"requireQuiz":true,"requireVisit":true,"isSecret":false,"isFinal":false,"quiz":{"items":[{"prompt":"Ciao {{nome}} sono l'84, non temere i miei confini, cercami il cuore tra piccoli primi. Dividi, controlla, ritorna e conferma: quando vedi soltanto primi, la prova è ferma.  ","ok":["2*2*3*7"]},{"prompt":"Ciao {{nome}} sono il 108, non temere i miei confini, cercami il cuore tra piccoli primi. Dividi, controlla, ritorna e conferma: quando vedi soltanto primi, la prova è ferma. ","ok":["2*2*3*3*3"]},{"prompt":"Ciao {{nome}} sono il 96, non temere i miei confini, cercami il cuore tra piccoli primi. Dividi, controlla, ritorna e conferma: quando vedi soltanto primi, la prova è ferma. ","ok":["2*2*2*2*2*3"]}],"onCorrect":"stanza_3"}},{"id":"corridoio_4","text":"Ti trovi in un lungo corridoio.\\n\nSulla parete a ovest un tessuto strappato e dai colori sbiaditi è attaccato per un angolo ad un chiodo.\\n\nA sud il corridoio continua.\\n\nA nord il corridoio continua.\\n\n","choices":[{"label":"nord|vado a nord","target":"corridoio_2"},{"label":"sud|vado a sud","target":"ingresso_1"},{"label":"osservo il tessuto|guardo il tessuto","target":"tessuto"}],"requireQuiz":false,"requireVisit":false,"isSecret":false,"isFinal":false},{"id":"ingresso_1","text":"TI trovi in quello che sembra l'ingresso dell'edificio. Tutto è sporco, impolverato e malandato.\\n\nA nord il corridoio continua.\\n\nA ovest c'è una porta murata.\\n\nA sud il corridoio continua.\\n\nSulla parete a nord ci sono alcuni resti di fogli con disegni ingialliti e scoloriti, attaccati ad un panello di sughero ammuffito.\\n\nA est si trova un portone chiuso con delle assi di legno inchiodate. Alla sua sinistra c'è una cattedra con sopra ammassati dei banchini rotti.\\n\nLa parete a sud è mezza crollata e alla sua base si trovano delle macerie.\\n","choices":[{"label":"nord|vado a nord","target":"corridoio_4"},{"label":"vado a sud|sud","target":"corridoio_5"},{"label":"osservo la porta a est|guardo la porta a est|osservo il portone a est|osservo il portone|guardo il portone a est|guardo il portone","target":"porta_ingresso_1"},{"label":"osservo la cattedra|guardo la cattedra|scruto la cattedra","target":"cattedra_1"},{"label":"osservo la porta a ovest|guardo la porta a ovest","target":"porta_ingresso_1_ovest"}],"requireQuiz":false,"requireVisit":false,"isSecret":false,"isFinal":false},{"id":"porta_ingresso_1","text":"E' un grande portone di legno bloccato con delle assi inchiodate. Non sembra possibile aprirlo.","choices":[{"label":"indietro|vado indietro","target":"ingresso_1"}],"requireQuiz":false,"requireVisit":false,"isSecret":false,"isFinal":false},{"id":"cattedra_1","text":"Una vecchia cattedra di legno impolverata e con le parti di legno scheggiate. Dei due cassetti originari presenti ne è rimasto solo uno ed è poco impolverato rispetto al resto della cattedra","choices":[{"label":"indietro|vado indietro","target":"ingresso_1"},{"label":"apro il cassetto","target":"cassetto_1"}],"requireQuiz":false,"requireVisit":false,"isSecret":false,"isFinal":false},{"id":"cassetto_1","text":"Dentro al cassetto c'è un foglio di carta ripiegato, lo apri e vedi un disegno fatto a matita di una bicicletta con il telaio verde e le ruote nere.\\n\nIn basso c'è una scritta cancellata, probabilmente dell'autore del disegno, si legge solo la lettera \"l\".","choices":[{"label":"indietro|vado indietro","target":"ingresso_1"}],"requireQuiz":false,"requireVisit":false,"isSecret":true,"isFinal":false},{"id":"porta_ingresso_1_ovest","text":"Nello spazio dove prima ci doveva essere una porta a due ante di legno ora ci sono solidi mattoni.","choices":[{"label":"indietro|vado indietro","target":"ingresso_1"}],"requireQuiz":false,"requireVisit":false,"isSecret":false,"isFinal":false},{"id":"tessuto","text":"Sembra un pezzo di lenzuolo ritagliato dove era stato disegnato qualcosa ma non riesci a distinguere nulla.","choices":[{"label":"indietro|vado indietro","target":"corridoio_4"}],"requireQuiz":false,"requireVisit":false,"isSecret":false,"isFinal":false},{"id":"corridoio_5","text":"Sulle pareti del corridoio ci sono disegnate delle linee colorate ormai quasi completamente cancellate dal tempo.\\n\nA nord il corridoio prosegue.\\n\nA ovest una piccola porta, accanto c'è la scritta \"bagni\".\\n\nA est una porta antipanico con i vetri completamente ingialliti e opachi.\\n\nA sud il corridoio continua.","choices":[{"label":"vado a nord|nord","target":"ingresso_1"},{"label":"vado a sud|sud","target":"corridoio_6"},{"label":"guardo la porta a ovest|osservo la porta a ovest","target":"porta_ovest_corridoio_5"},{"label":"guardo la porta antipanico|osservo la porta antipanico|guardo la porta a est|osservo la porta a est","target":"porta_est_corridoio_5"}],"requireQuiz":false,"requireVisit":false,"isSecret":false,"isFinal":false},{"id":"porta_ovest_corridoio_5","text":"La porta è chiusa ma un odore nauseabondo pervade dalle fessure. \\n\nNon hai nessuna intenzione di entrare.","choices":[{"label":"indietro|vado indietro","target":"corridoio_5"}],"requireQuiz":false,"requireVisit":false,"isSecret":false,"isFinal":false},{"id":"porta_est_corridoio_5","text":"La porta ha un maniglione antipanico di colore rosso mezzo rotto. Dai vetri si intravede qualcosa.","choices":[{"label":"indietro|vado indietro","target":"corridoio_5"},{"label":"guardo attraverso i vetri|guardo i vetri|osservo attraverso i vetri|osservo i vetri","target":"vetri_porta_est"}],"requireQuiz":false,"requireVisit":false,"isSecret":false,"isFinal":false},{"id":"vetri_porta_est","text":"Ti avvicini ai vetri e riesci a scorgere delle ombre, sembrano enormi scaffali caduti uno sopra l'altro.\\n\nSopra di essi vedi una figura umana ma non ne sei sicuro.","choices":[{"label":"indietro|vado indietro","target":"corridoio_5"},{"label":"colpisco i vetri|rompo i vetri|do un colpo|do un pugno ai vetri|do un calcio alla porta|colpisco la porta|rompo la porta|do un colpo|do un pugno ai vetri|do un calcio ai vetri|apro la porta|apro la maniglia","target":"vetri_porta_est_2"}],"requireQuiz":false,"requireVisit":false,"isSecret":false,"isFinal":false},{"id":"vetri_porta_est_2","text":"I vetri sono resistenti e la porta non si apre.\\n\nNoti però che la figura umana si è mossa leggermente quando hai fatto rumore.","choices":[{"label":"indietro|vado indietro","target":"corridoio_5"}],"requireQuiz":false,"requireVisit":false,"isSecret":false,"isFinal":false},{"id":"corridoio_6","text":"Sei alla fine del lungo corridoio.\\n\nA sud un muro di mattoni ti impedisce il passaggio\\n\nA est c'è un'apertura che da su un'altra stanza, sopra questa apertura c'è ciò che rimane di una scritta \"-i--io--c-\"","choices":[{"label":"nord|vado a nord","target":"corridoio_5"},{"label":"vado a est|est|entro nella stanza|entro nella stanza a est|entro nell'apertura|vado nell'apertura|vado nella stanza","target":"stanza_4"},{"label":"osservo il muro|guardo il muro","target":"muro_corridoio_6"}],"requireQuiz":false,"requireVisit":false,"isSecret":false,"isFinal":false},{"id":"muro_corridoio_6","text":"E' un muro di mattoni.","choices":[{"label":"indietro|vado indietro","target":"corridoio_6"}],"requireQuiz":false,"requireVisit":false,"isSecret":false,"isFinal":false},{"id":"stanza_4","text":"La stanza è molto grande con i soffitti alti. Ci sono file irregolari di banchini al centro, sulle superfici, polvere a velo e cerchi opachi lasciati da vecchi bicchieri. \\n\nSulla parete a nord sono posizionati scaffali bassi con libri disallineati: dorsi scoloriti, etichette strappate, qualche volume aperto a pancia in giù.\\n\nNella parete a sud, una cattedra in legno laminato segnata da graffi; sopra di essa, attaccata al muro un monitor con un vetro opaco e una piccola luce rossa lampeggiante\\n\nSulla parete a est due finestre alte, a mezza altezza del muro, sono sbarrate dall’interno con pannelli sottili: lasciano filtrare un chiarore polveroso, più grigio che luce. Sotto di esse su un tavolo lungo, tre PC abbandonati: monitor spenti, tasti mancanti, cavi intrecciati come radici secche. L’aria sa di carta vecchia e cera per pavimenti, con una nota fredda di metallo.\n","choices":[{"label":"osservo gli scaffali a nord|guardo gli scaffali a nord|guardo gli scaffali|osservo gli scaffali","target":"stanza_4_scaffali"},{"label":"osservo il monitor|guardo il monitor|mi avvicino al monitor|osservo il monitor a sud|guardo il monitor a sud","target":"stanza_4_monitor"},{"label":"osservo i PC|guardo i PC|osservo i PC a est|guardo i PC a est","target":"stanza_4_PC"}],"requireQuiz":false,"requireVisit":false,"isSecret":false,"isFinal":false},{"id":"stanza_4_scaffali","text":"Negli scaffali la maggior parte dei libri ha tutte le pagine colorate di nero con un pennarello, quindi illeggibili, oppure strappate o scarabocchiate.\\n\nL'unico libro che sembra intatto ha scritto sulla copertina \"Elementi-Euclide\"","choices":[{"label":"indietro|vado indietro","target":"stanza_4"},{"label":"prendo il libro|osservo il libro|leggo il libro","target":"stanza_4_libro"}],"requireQuiz":false,"requireVisit":false,"isSecret":false,"isFinal":false},{"id":"stanza_4_libro","text":"Sfogli il libro e ti accorgi che tutte le pagine sono bianche tranne una dove è scritto:\\n\\n\n\nTeorema fondamentale della aritmetica: Ogni numero naturale maggiore di 1 o è un numero primo o si può esprimere come prodotto di numeri primi. Tale rappresentazione è unica, se si prescinde dall'ordine in cui compaiono i fattori.\\n\\n\n\nPiù sotto, a penna, è scritto:\\n\\n\n\nPer scomporre un numero in fattori primi bisogna riscrivere il numero come prodotto di numeri primi. Il prodotto il prodotto di più numeri uguali può essere scritto in potenza.\n\n","choices":[{"label":"indietro|vado indietro","target":"stanza_4"}],"requireQuiz":false,"requireVisit":false,"isSecret":false,"isFinal":false},{"id":"stanza_4_monitor","text":"Ti avvicini al monitor che si illumina all'improvviso. Sullo schemo appaiono dei caratteri instabili che lampeggiano:\\n\\n\n\nCiao {{nome}}.\\n\nNel corridoio muto, tra neon cangianti,\\n\nil numero N sussurra ai passanti:\\n\n“Spezzami in primi, piano e con senno,\\n\nfinché nessun fattore resti più inganno.\\n\nPoi conta quante volte ognun ricorre,\\n\ne in potenze il mio segreto fai correre:\\n\nscrivi la mia firma chiara e compatta.\\n\"","choices":[],"requireQuiz":true,"requireVisit":true,"isSecret":false,"isFinal":false,"quiz":{"items":[{"prompt":"N è 120","ok":["2^2*3*5"]},{"prompt":"N è 184","ok":["2^3*23"]},{"prompt":"N è 168","ok":["2^3*3*7"]}],"onCorrect":"stanza_4"}},{"id":"stanza_4_PC","text":"I tre computer sono impolverati e mal ridotti, non credi possano funzionare.\\n\nSulla scocca è scritto \"chromebook\"","choices":[{"label":"indietro|torno indietro","target":"stanza_4"}],"requireQuiz":false,"requireVisit":false,"isSecret":false,"isFinal":false},{"id":"prova_finale","text":"Due numeri A e B camminano fianco a fianco.\\n\n Cerca la più grande misura che li divide entrambi senza lasciare avanzo:\\n\nquella è la prima risposta.\\n\n Poi trova il più piccolo passo in cui i loro ritmi tornano insieme:\\n\n quella è la seconda risposta.","choices":[{"label":"vai avanti|prosegui","target":""}],"requireQuiz":false,"requireVisit":false,"isSecret":false,"isFinal":true,"quiz":{"items":[{"prompt":"A è 8 B è 12","ok":["4 24"]},{"prompt":"A è 6 B è 8","ok":["2 24"]},{"prompt":"A è 10 B è 12","ok":["2 60"]}],"onCorrect":"la_scalinata"}}]};  let player = { name:"" };  let activeQuiz = {};     let usedIdx = {};        const progress = { done:new Set(), visited:new Set(), secrets:0 };  function $(s){ return document.querySelector(s); }  function esc(s){ return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }  function norm(s){ s=String(s||"").toLowerCase(); if(s.normalize){s=s.normalize("NFD").replace(/[̀-ͯ]/g,"");} s=s.replace(/\s+/g," " ).trim(); return s; }  function stripSpacesLower(s){ return String(s||"").toLowerCase().replace(/\s+/g,""); }  function htmlFromText(txt){    var t = String(txt||"" );    t = t.replace(/\\n/g, "\n");    t = t.replace(/\r\n?/g, "\n");    t = t.split("{{nome}}").join(player.name);    t = esc(t).replace(/\n/g, "<br>");    return t;  }  function start(){ const root = $("#root"); var h = "" + "<h1>"+esc(story.title||"Avventura")+"</h1>"+ "<div class=\"small\">Avventura testuale — digita i comandi (es. <i>attraverso la porta</i>)</div>"+ "<div style=\"margin:12px 0\">"+ "<label class=\"small\">Il tuo nome</label>"+ "<input id=\"pname\" placeholder=\"Es. Paola\">"+ "</div>"+ "<input type=\"button\" id=\"btnBegin\" value=\"Inizia\">"; root.innerHTML = h; document.getElementById("btnBegin").addEventListener("click", begin); }  function begin(){ var v = (document.getElementById("pname").value||"").trim(); player.name = v || "Viaggiatore"; goto(story.start || (story.nodes[0] && story.nodes[0].id) || ""); }  function nodeById(id){ var list = story.nodes||[]; for(var i=0;i<list.length;i++){ if(list[i].id===id) return list[i]; } return null; }  function pickIdxFor(nodeId, itemsLen){ var used = usedIdx[nodeId] || (usedIdx[nodeId]=[]); if(itemsLen<=0) return -1; if(used.length >= itemsLen) used.length = 0; var pool = []; for(var i=0;i<itemsLen;i++){ if(used.indexOf(i)===-1) pool.push(i); } var idx = pool[Math.floor(Math.random()*pool.length)]; used.push(idx); return idx; }  function ensureActiveQuiz(n){ if(!n.quiz || !Array.isArray(n.quiz.items) || !n.quiz.items.length) return null; var cur = activeQuiz[n.id]; if(cur && cur.itemsLen===n.quiz.items.length) return cur; var idx = pickIdxFor(n.id, n.quiz.items.length); if(idx<0) return null; var it = n.quiz.items[idx]; activeQuiz[n.id] = { idx:idx, prompt:String(it.prompt||""), ok:(it.ok||[]).slice(), itemsLen:n.quiz.items.length }; return activeQuiz[n.id]; }  function goto(id){ var n = nodeById(id); if(!n){ $("#root").innerHTML = "<div>Scena non trovata: "+esc(id)+"</div>"; return; } if(n.isFinal && !canFinish()){ showMsg("⚠️ Non puoi ancora accedere alla scena finale. Completa prima i requisiti."); return; } if(n.isSecret && !window.__secretSeen?.has(n.id)){ window.__secretSeen = window.__secretSeen || new Set(); window.__secretSeen.add(n.id); progress.secrets += 1; } renderScene(n); }  function renderScene(n){ progress.visited.add(n.id); var quiz = ensureActiveQuiz(n); var base = String(n.text||"");if(quiz){if(base.indexOf("{{prompt}}")!==-1){ base = base.replace(/\{\{prompt\}\}/g, quiz.prompt); } else { base = base + (base?"\n\n":"") + quiz.prompt; } } var html = ""; html += "<h1>"+esc(story.title||"Avventura")+"</h1>"; html += "<div class=\"hud\">"+ hudHTML() +"</div>"; html += "<div class=\"small\">Scena: <b>"+esc(n.id)+"</b>"+(n.isFinal?" (Finale)":"")+"</div>"; html += "<div style=\"line-height:1.5;margin:10px 0 12px; text-align:left\">"+ htmlFromText(base) +"</div>"; html += "<input id=\"cmd\" placeholder=\"Scrivi un'azione o la risposta e premi Invio\">"; html += "<div id=\"msg\" class=\"msg\"></div>"; $("#root").innerHTML = html; var inp = document.getElementById("cmd"); inp.focus(); inp.addEventListener("keydown", function(ev){ if(ev.key==="Enter"){ var raw = inp.value; inp.value=""; handleCommand(n, raw); } }); } function hudHTML(){ var y = (story.totalRequired|0); var s = "<div class=\"badge\">prove superate: "+progress.done.size+"/"+y+"</div>"; if(progress.secrets>0){ s += "<div class=\"badge\" style=\"margin-top:6px\">segreti trovati:"+progress.secrets+"</div>"; } return s; }  function matchAnswer(raw, ok){ return stripSpacesLower(raw) === stripSpacesLower(ok); }  function handleCommand(n, raw){ var quiz = (n.quiz && n.quiz.items && n.quiz.items.length) ? activeQuiz[n.id] : null; if(quiz && quiz.ok && quiz.ok.length){ for(var i=0;i<quiz.ok.length;i++){ if(matchAnswer(raw, quiz.ok[i])){ if(n.quiz.onCorrect){ if(n.requireQuiz){ progress.done.add(n.id); } delete activeQuiz[n.id]; goto(n.quiz.onCorrect); return; } } } } var user = norm(raw); if(!user){ showMsg("⚠️ Digita qualcosa."); return; } var ch = n.choices || []; for(var j=0;j<ch.length;j++){ var patterns = String(ch[j].label||"").split("|"); for(var k=0;k<patterns.length;k++){ var p = norm(patterns[k]); if(p && user===p){ var target = ch[j].target||""; if(nodeById(target)?.isFinal && !canFinish()){ showMsg("⚠️ Ti manca ancora qualcosa prima di entrare lì."); return; } goto(target); return; } } } showMsg("❓ Non succede nulla… (comando non riconosciuto)"); }  function canFinish(){ var need = (story.totalRequired|0); if(progress.done.size < need) return false; var must = (story.nodes||[]).filter(x=>x.requireVisit).map(x=>x.id); for(var i=0;i<must.length;i++){ if(!progress.visited.has(must[i])) return false; } return true; }  function showMsg(txt){ var el = document.getElementById("msg"); if(el){ el.className = "msg warn"; el.innerHTML = esc(txt); } }  window.addEventListener("DOMContentLoaded", start);})();</script></body></html>
